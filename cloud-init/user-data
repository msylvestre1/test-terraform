#cloud-config
# Ubuntu 22.04 Autoinstall template file
#
#   Created on        : 2024-02-22
#   Author(s)         : Alassane Maiga
#
#   Last Modification : 2024-07-17
#   Author(s)         : Mathieu Sylvestre
#
#========================Server Configuration========================================#
autoinstall:
  version: 1
  apt:
    disable_components: []
    fallback: abort
    geoip: true
    mirror-selection:
      primary:
        - country-mirror
        - arches: &id001
            - amd64
            - i386
          uri: http://archive.ubuntu.com/ubuntu/
    preserve_sources_list: false
    security:
      - arches: *id001
        uri: http://security.ubuntu.com/ubuntu/
  codecs:
    install: false
  drivers:
    install: false
  keyboard:
    layout: us
    toggle: null
    variant: ""
  locale: en_US.UTF-8
  source:
    id: ubuntu-server
    search_drivers: false
  ssh:
    allow-pw: true
    authorized-keys: []
    install-server: true
  #========================Kernel Select========================================#
  #kernel:
  #  package: linux-generic
  oem:
    install: auto
  #========================Partitioning Scheme========================================#
  storage:
    config:
      - ptable: gpt
        path: /dev/sda
        wipe: superblock-recursive
        preserve: false
        name: ""
        grub_device: false
        id: disk-sda
        type: disk
      - device: disk-sda
        size: 1G
        wipe: superblock
        flag: boot
        number: 1
        preserve: false
        grub_device: true
        path: /dev/sda1
        id: part-efi
        type: partition
      - fstype: fat32
        volume: part-efi
        preserve: false
        id: format-efi
        type: format
      - device: disk-sda
        size: 1G
        wipe: superblock
        number: 2
        preserve: false
        grub_device: false
        path: /dev/sda2
        id: part-boot
        type: partition
      - fstype: ext4
        volume: part-boot
        preserve: false
        id: format-boot
        type: format
      - path: /dev/sda3
        id: part_swap
        size: 4G
        preserve: false
        wipe: superblock
        device: disk-sda
        number: 3
        grub_device: false
        type: partition
        flag: swap
      - volume: part_swap
        fstype: swap
        id: format-swap
        type: format
      - device: disk-sda
        size: -1
        wipe: superblock
        number: 4
        preserve: false
        grub_device: false
        path: /dev/sda4
        id: part_lvmpv
        type: partition
      - name: lvm_vg00
        devices:
          - part_lvmpv
        preserve: false
        id: lvm_vg00
        type: lvm_volgroup
      - name: lv_home
        volgroup: lvm_vg00
        size: 4G
        wipe: superblock
        preserve: false
        path: /dev/lvm_vg00/lv_home
        id: part_home
        type: lvm_partition
      - fstype: ext4
        volume: part_home
        preserve: false
        id: format-home
        type: format
      - name: lv_tmp
        volgroup: lvm_vg00
        size: 8G
        wipe: superblock
        preserve: false
        path: /dev/lvm_vg00/lv_tmp
        id: part_tmp
        type: lvm_partition
      - fstype: ext4
        volume: part_tmp
        preserve: false
        id: format-tmp
        type: format
      - name: lv_var
        volgroup: lvm_vg00
        size: 15G
        wipe: superblock
        preserve: false
        path: /dev/lvm_vg00/lv_var
        id: part_var
        type: lvm_partition
      - fstype: ext4
        volume: part_var
        preserve: false
        id: format-var
        type: format
      - name: lv_varlog
        volgroup: lvm_vg00
        size: 15G
        wipe: superblock
        preserve: false
        path: /dev/lvm_vg00/lv_varlog
        id: part_varlog
        type: lvm_partition
      - fstype: ext4
        volume: part_varlog
        preserve: false
        id: format-varlog
        type: format
      - name: lv_varlogaudit
        volgroup: lvm_vg00
        size: 2G
        wipe: superblock
        preserve: false
        path: /dev/lvm_vg00/lv_varlogaudit
        id: part_varlogaudit
        type: lvm_partition
      - fstype: ext4
        volume: part_varlogaudit
        preserve: false
        id: format-varlogaudit
        type: format
      - name: lv_root
        volgroup: lvm_vg00
        size: -1
        wipe: superblock
        preserve: false
        path: /dev/lvm_vg00/lv_root
        id: part_root
        type: lvm_partition
      - fstype: ext4
        volume: part_root
        preserve: false
        id: format-root
        type: format
      - path: /
        device: format-root
        id: mount-root
        type: mount
      - path: /boot
        device: format-boot
        id: mount-boot
        type: mount
      - path: /boot/efi
        device: format-efi
        options: uid=0,gid=0,umask=0077
        id: mount-efi
        type: mount
      - path: /home
        device: format-home
        id: mount-home
        options: nodev,noexec,auto,nouser,async,acl
        type: mount
      - path: /tmp
        device: format-tmp
        id: mount-tmp
        type: mount
      - path: /var
        device: format-var
        id: mount-var
        type: mount
      - path: /var/log
        device: format-varlog
        id: mount-varlog
        type: mount
      - path: /var/log/audit
        device: format-varlogaudit
        id: mount-varlogaudit
        type: mount
  #========================Cloud-init Cleanup========================================#
  user-data:
    write_files:
      - path: /root/init-script.sh
        permissions: "700"
        owner: root:root
        content: |
          #!/bin/bash
          echo 'datasource_list: [ NoCloud, ConfigDrive, Azure, AltCloud ,OVF ,VMware ,None ]' | sudo -s tee /etc/cloud/cloud.cfg.d/90_dpkg.cfg
          dpkg-reconfigure -f noninteractive cloud-init
          rm /root/init-script.sh
          history -c
          cloud-init clean --reboot
    runcmd:
      - /root/init-script.sh
